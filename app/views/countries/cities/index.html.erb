<%= turbo_refreshes_with method: :morph, scroll: :preserve %>

<% title "Cities in #{@country.name}" %>

<%= render "shared/location_header",
      name: @country.name,
      subtitle: "#{@country.name}, #{@country.continent_name}",
      flag_code: @country.alpha2,
      stats: "#{pluralize(@cities.size, "city")} with Ruby events in #{@country.name}",
      location: @country %>

<%= render "shared/location_navigation",
      location: @country,
      current_tab: "cities",
      show_cities: true,
      show_states: State.supported_country?(@country),
      show_stamps: true %>

<div class="container py-8">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-bold text-gray-900">Cities in <%= @country.name %></h2>
      <%= ui_badge(@cities.size, kind: :secondary, outline: true) %>
    </div>

    <div class="flex items-center gap-2">
      <span class="text-sm text-gray-500">Sort:</span>
      <%= link_to "Events", country_cities_path(@country, sort: "events"),
            class: "btn btn-sm #{(@sort == "events") ? "btn-primary" : "btn-ghost"}" %>
      <%= link_to "A-Z", country_cities_path(@country, sort: "name"),
            class: "btn btn-sm #{(@sort == "name") ? "btn-primary" : "btn-ghost"}" %>
    </div>
  </div>

  <% if @cities.any? %>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      <% @cities.each do |city| %>
        <%= link_to city.path,
              class: "flex flex-col p-4 bg-white rounded-xl border hover:border-gray-400 transition-colors" do %>
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-gray-900"><%= city.name %></span>
              <% if @show_states && city.state_code.present? %>
                <span class="text-sm text-gray-400"><%= city.state_code %></span>
              <% end %>
            </div>
            <%= ui_badge(city.events_count, kind: :secondary, outline: true, size: :sm) %>
          </div>

          <div class="text-sm text-gray-500">
            <%= pluralize(city.events_count, "event") %>
          </div>

          <% if city.events.any? %>
            <div class="flex -space-x-2 mt-3">
              <% city.events.first(4).each do |event| %>
                <% if event.avatar_image_path %>
                  <div class="w-8 h-8 rounded overflow-hidden ring-2 ring-white">
                    <%= image_tag event.avatar_image_path, alt: event.name, class: "w-full h-full object-cover", loading: "lazy" %>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <p class="text-gray-500 py-8 text-center">No cities with events found in <%= @country.name %> yet.</p>
  <% end %>
</div>
