<%= turbo_refreshes_with method: :morph, scroll: :preserve %>

<div class="container py-8">
  <div class="block lg:flex gap-8 align-center justify-between">
    <div class="flex flex-col lg:flex-row gap-8 items-center lg:justify-right text-center lg:text-left mb-6 lg:mb-0">
      <% if @country.present? %>
        <span class="fi fi-<%= @country.alpha2.downcase %> border rounded w-36 text-[80pt]"></span>
      <% end %>
      <div class="flex-col flex justify-center">
        <h1 class="mb-2 text-black font-bold">
          <%= title "Ruby Community in #{@location}" %>
        </h1>
        <h3 class="hidden md:block text-[#636B74]">
          <%= link_to @country.name, country_path(@country), class: "hover:underline" %>
        </h3>
      </div>
    </div>

    <div class="flex flex-col gap-3 place-items-center">
      <%= ui_button "View all events in #{@country.name}", url: country_path(@country), kind: :secondary, size: :sm, class: "w-full" %>
    </div>
  </div>

  <p class="mt-3 md:mt-9 mb-6 text-[#636B74] max-w-[700px]">
    We have indexed <%= pluralize(@users.count, "Rubyist") %> and <%= pluralize(@events.count, "event") %> in <%= @location %>.
  </p>

  <% if @users.any? %>
    <div id="rubyists" class="mt-12">
      <section class="flex flex-col w-full gap-4">
        <div class="flex items-center justify-between w-full">
          <h2 class="text-primary shrink-0">Rubyists in <%= @location %></h2>
        </div>
        <div class="grid min-w-full grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
          <%= cache @users do %>
            <%= render partial: "users/card", collection: @users, as: :user, cached: true %>
          <% end %>
        </div>
      </section>
    </div>
  <% end %>

  <% if @nearby_users&.any? %>
    <div id="nearby-rubyists" class="mt-12">
      <section class="flex flex-col w-full gap-4">
        <div class="flex items-center justify-between w-full">
          <h2 class="text-primary shrink-0">Rubyists near <%= @location %></h2>
        </div>
        <div class="grid min-w-full grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
          <% @nearby_users.each do |nearby| %>
            <% user = nearby[:user] %>
            <% distance_km = nearby[:distance_km] %>
            <%= render partial: "users/card", locals: {user: user, content: capture do %>
              <span><%= [user.location_info.display_city, user.location_info.country&.name].compact.join(", ") %></span>
              <span class="text-gray-400">&middot;</span>
              <span><%= distance_km %> km</span>
            <% end} %>
          <% end %>
        </div>
      </section>
    </div>
  <% end %>

  <% if (groups = @events.group_by(&:kind)).any? %>
    <% groups.each do |kind, events| %>
      <div id="events" class="mt-12">
        <section class="flex flex-col w-full gap-4">
          <div class="flex items-center justify-between w-full">
            <h2 class="text-primary shrink-0"><%= kind.humanize.pluralize %></h2>
          </div>
          <div class="grid min-w-full grid-cols-1 gap-8 sm:grid-cols-2 md:grid-cols-3 md:[&>:nth-child(4)]:hidden lg:grid-cols-4 lg:[&>:nth-child(4)]:block">
            <%= cache events do %>
              <%= render partial: "events/card", collection: events, as: :event, cached: true %>
            <% end %>
          </div>
        </section>
      </div>
    <% end %>
  <% end %>

  <% if @nearby_events&.any? %>
    <% nearby_groups = @nearby_events.group_by { |ne| ne[:event].kind } %>
    <% nearby_groups.each do |kind, nearby_events| %>
      <div id="nearby-events" class="mt-12">
        <section class="flex flex-col w-full gap-4">
          <div class="flex items-center justify-between w-full">
            <h2 class="text-primary shrink-0"><%= kind.humanize.pluralize %> near <%= @location %></h2>
          </div>
          <div class="grid min-w-full grid-cols-1 gap-8 sm:grid-cols-2 md:grid-cols-3 md:[&>:nth-child(4)]:hidden lg:grid-cols-4 lg:[&>:nth-child(4)]:block">
            <% nearby_events.each do |nearby| %>
              <% event = nearby[:event] %>
              <% distance_km = nearby[:distance_km] %>
              <div class="relative">
                <%= render partial: "events/card", locals: {event: event} %>
                <div class="absolute bottom-2 right-2 text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                  <%= distance_km %> km away
                </div>
              </div>
            <% end %>
          </div>
        </section>
      </div>
    <% end %>
  <% end %>
</div>
